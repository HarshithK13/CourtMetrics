{% extends "base.html" %}

{% block title %}Forgot Password{% endblock %}

{% block content %}
<div id="root"></div>

<script type="text/babel">
    const ForgotPassword = () => {
        const [username, setUsername] = React.useState('');
        const [email, setEmail] = React.useState('');
        const [otp, setOtp] = React.useState('');
        const [newPassword, setNewPassword] = React.useState('');
        const [confirmPassword, setConfirmPassword] = React.useState('');
        const [message, setMessage] = React.useState('');
        const [step, setStep] = React.useState(1); // Step 1: Request OTP, Step 2: Verify OTP & Reset Password

        // Handle sending OTP
        const handleSendOtp = async (event) => {
            event.preventDefault();
            setMessage('');

            try {
                const response = await fetch('/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ username, email })
                });
                const data = await response.json();
                if (response.ok) {
                    setMessage(data.message || "OTP sent successfully!");
                    setStep(2); // Move to the next step
                } else {
                    setMessage(data.error || "Failed to send OTP.");
                }
            } catch (error) {
                setMessage("An error occurred while sending OTP.");
            }
        };

        // Handle OTP verification and password reset
        const handleResetPassword = async (event) => {
            event.preventDefault();
            setMessage('');

            if (newPassword !== confirmPassword) {
                setMessage("Passwords do not match.");
                return;
            }

            if (newPassword.length < 12) {
                setMessage("Password must be at least 12 characters long.");
                return;
            }

            try {
                // Verify OTP and reset password
                const response = await fetch('/reset_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        username,
                        email,
                        otp,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    setMessage("Password reset successful! Please log in.");
                    window.location.href = '/login';
                } else {
                    setMessage(data.error || "Failed to reset password.");
                }
            } catch (error) {
                setMessage("An error occurred while resetting the password.");
            }
        };

        return (
            <div className="forgot-password-container">
                <h2>Forgot Password</h2>
                {message && <p className="message">{message}</p>}

                {step === 1 && (
                    <form onSubmit={handleSendOtp} className="forgot-password-form">
                        <label htmlFor="username">Enter your username:</label>
                        <input
                            type="text"
                            id="username"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            required
                            className="form-input"
                        />
                        <label htmlFor="email">Enter your email:</label>
                        <input
                            type="email"
                            id="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                            className="form-input"
                        />
                        <button type="submit" className="submit-button">Send OTP</button>
                    </form>
                )}

                {step === 2 && (
                    <form onSubmit={handleResetPassword} className="reset-password-form">
                        <label htmlFor="otp">Enter the OTP:</label>
                        <input
                            type="text"
                            id="otp"
                            value={otp}
                            onChange={(e) => setOtp(e.target.value)}
                            required
                            className="form-input"
                        />
                        <label htmlFor="new-password">New Password:</label>
                        <input
                            type="password"
                            id="new-password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            required
                            className="form-input"
                        />
                        <label htmlFor="confirm-password">Confirm New Password:</label>
                        <input
                            type="password"
                            id="confirm-password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            required
                            className="form-input"
                        />
                        <button type="submit" className="submit-button">Reset Password</button>
                    </form>
                )}
            </div>
        );
    };

    ReactDOM.render(<ForgotPassword />, document.getElementById('root'));
</script>
{% endblock %}
