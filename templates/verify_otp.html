{% extends "base.html" %}

{% block title %}Verify OTP{% endblock %}

{% block content %}
<div id="root"></div>

<script type="text/babel">
    const VerifyOtp = () => {
        const [email, setEmail] = React.useState('');
        const [otp, setOtp] = React.useState('');
        const [newPassword, setNewPassword] = React.useState('');
        const [confirmPassword, setConfirmPassword] = React.useState('');
        const [message, setMessage] = React.useState('');
        const [step, setStep] = React.useState(1); // Step 1: Verify OTP, Step 2: Reset Password

        // Handle OTP verification
        const handleVerifyOtp = async (event) => {
            event.preventDefault();
            setMessage('');

            try {
                const response = await fetch(`/verify-otp?email=${encodeURIComponent(email)}&otp=${encodeURIComponent(otp)}`);
                const data = await response.json();
                if (response.ok) {
                    setMessage("OTP verified successfully! Please reset your password.");
                    setStep(2); // Move to the next step
                } else {
                    setMessage(data.error || "Invalid OTP.");
                }
            } catch (error) {
                setMessage("An error occurred while verifying OTP.");
            }
        };

        // Handle password reset
        const handleResetPassword = async (event) => {
            event.preventDefault();
            setMessage('');

            if (newPassword !== confirmPassword) {
                setMessage("Passwords do not match.");
                return;
            }

            if (newPassword.length < 12) {
                setMessage("Password must be at least 12 characters long.");
                return;
            }

            try {
                const response = await fetch('/reset_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        email,
                        otp,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    setMessage("Password reset successful! Please log in.");
                    window.location.href = '/login';
                } else {
                    setMessage(data.error || "Failed to reset password.");
                }
            } catch (error) {
                setMessage("An error occurred while resetting the password.");
            }
        };

        return (
            <div className="verify-otp-container">
                <h2>Verify OTP</h2>
                {message && <p className="message">{message}</p>}

                {step === 1 && (
                    <form onSubmit={handleVerifyOtp} className="verify-otp-form">
                        <label htmlFor="email">Email:</label>
                        <input
                            type="email"
                            id="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                            className="form-input"
                        />
                        <label htmlFor="otp">Enter OTP:</label>
                        <input
                            type="text"
                            id="otp"
                            value={otp}
                            onChange={(e) => setOtp(e.target.value)}
                            required
                            className="form-input"
                        />
                        <button type="submit" className="submit-button">Verify OTP</button>
                    </form>
                )}

                {step === 2 && (
                    <form onSubmit={handleResetPassword} className="reset-password-form">
                        <label htmlFor="new-password">New Password:</label>
                        <input
                            type="password"
                            id="new-password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            required
                            className="form-input"
                        />
                        <label htmlFor="confirm-password">Confirm New Password:</label>
                        <input
                            type="password"
                            id="confirm-password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            required
                            className="form-input"
                        />
                        <button type="submit" className="submit-button">Reset Password</button>
                    </form>
                )}
            </div>
        );
    };

    ReactDOM.render(<VerifyOtp />, document.getElementById('root'));
</script>
{% endblock %}
